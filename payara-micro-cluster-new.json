{
  "jpsType": "install",
  "application": {
    "name": "Payara Micro Cluster",
    "homepage": "http://jelastic.com/",
    "description": "Autoscalable and Highly Available Payara Micro Cluster",
    "env": {
      "topology": {
        "nodes": [
          {
            "nodeType": "docker",
            "cloudlets": 16,
            "count": 2,
            "nodeGroup": "cp",
            "displayName": "PayaraCluster",
            "docker": {
              "image": "jelastic/payara",
              "env": {
                "PORT": "5080",
                "HAZELCAST_USER": "DONT_BE_DUPE_CHANGE_ME",
                "HAZELCAST_PASSWORD": "DONT_BE_DUPE_CHANGE_ME"
              },
            }
          }
        ]
      }
    },
    "onInstall": {
      "call": [
        "updateClusterMembers"
      ]
    },
    "onAfterScaleOut[nodeGroup:cp]": {
      "call": [
        "updateClusterMembers",
      ]
    },
    "onAfterScaleIn[nodeGroup:cp]": {
      "forEach(${event.response.nodes})": {
        "execCmd": {
          "nodeId": "${@i.id}",
          "commands": [
            "sed -i '/${@i.intIP}'/d' /opt/hazelcast.xml"
          ]
        }
      }
    },
    "procedures": [
      {
        "id": "updateClusterMembers",
        "onCall": {
          "forEach(${event.response.nodes})": {
            "executeShellCommands": {
              "nodeId": "${@i.id}",
              "commands": [
                "sed -i '/<member-list/a  <member>${@i.intIP}</member>' /opt/hazelcast.xml",
                "updateClusterMembers"
              ],
              "user": "root"
            }
          }
        }
      },
      {
        "id": "removeMember",
        "onCall": {
          "executeShellCommands": {
            "nodeMission": "cp",
            "commands": [
              "sed '/${this.nodeip}/d' /opt/hazelcast.xml"
            ],
            "user": "root"
          }
        }
      }
    ]
  }
}
